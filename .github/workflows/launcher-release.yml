name: Release Launcher Installers

on:
  push:
    tags:
      - "launcher-v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
          - os: ubuntu-latest
            platform: linux

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: launcher/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install launcher dependencies
        working-directory: launcher
        run: npm ci

      - name: Verify macOS signing secrets
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          test -n "${{ secrets.APPLE_CERTIFICATE }}" || (echo "Missing APPLE_CERTIFICATE"; exit 1)
          test -n "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" || (echo "Missing APPLE_CERTIFICATE_PASSWORD"; exit 1)
          test -n "${{ secrets.APPLE_SIGNING_IDENTITY }}" || (echo "Missing APPLE_SIGNING_IDENTITY"; exit 1)
          test -n "${{ secrets.APPLE_ID }}" || (echo "Missing APPLE_ID"; exit 1)
          test -n "${{ secrets.APPLE_PASSWORD }}" || (echo "Missing APPLE_PASSWORD"; exit 1)
          test -n "${{ secrets.APPLE_TEAM_ID }}" || (echo "Missing APPLE_TEAM_ID"; exit 1)

      - name: Decode macOS signing certificate
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          CERT_PATH="$RUNNER_TEMP/apple-signing.p12"
          echo "${{ secrets.APPLE_CERTIFICATE }}" | base64 --decode > "$CERT_PATH"
          echo "APPLE_CERTIFICATE=$CERT_PATH" >> "$GITHUB_ENV"

      - name: Verify Windows signing secrets
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ secrets.WINDOWS_CERTIFICATE }}")) { throw "Missing WINDOWS_CERTIFICATE" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}")) { throw "Missing WINDOWS_CERTIFICATE_PASSWORD" }

      - name: Decode Windows signing certificate
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP "windows-signing.pfx"
          [System.IO.File]::WriteAllBytes($certPath, [System.Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE }}"))
          "WINDOWS_CERTIFICATE=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build launcher bundles (Linux)
        if: matrix.platform == 'linux'
        working-directory: launcher
        run: npm run tauri build -- --bundles appimage,deb

      - name: Build signed launcher bundles (macOS/Windows)
        if: matrix.platform != 'linux'
        working-directory: launcher
        run: npm run tauri build
        env:
          APPLE_CERTIFICATE: ${{ env.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          WINDOWS_CERTIFICATE: ${{ env.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      - name: Collect bundle artifacts (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          mkdir -p dist
          cp -R launcher/src-tauri/target/release/bundle/. dist/

      - name: Collect bundle artifacts (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item -Path "launcher/src-tauri/target/release/bundle/*" -Destination "dist" -Recurse -Force

      - name: Collect bundle artifacts (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          mkdir -p dist
          cp -R launcher/src-tauri/target/release/bundle/. dist/

      - name: Build checksums (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          cd dist
          find . -type f \
            ! -name "*.dSYM" \
            ! -name "*.sig" \
            -print0 | sort -z | xargs -0 shasum -a 256 > SHA256SUMS-${{ matrix.platform }}.txt

      - name: Build checksums (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $out = "dist/SHA256SUMS-${{ matrix.platform }}.txt"
          Remove-Item $out -ErrorAction SilentlyContinue
          Get-ChildItem dist -Recurse -File | Where-Object { $_.Extension -ne ".sig" } | Sort-Object FullName | ForEach-Object {
            $hash = (Get-FileHash -Algorithm SHA256 -Path $_.FullName).Hash.ToLower()
            $relative = Resolve-Path -Relative $_.FullName
            "$hash  $relative" | Out-File -FilePath $out -Encoding utf8 -Append
          }

      - name: Build checksums (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          cd dist
          find . -type f \
            ! -name "*.sig" \
            -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS-${{ matrix.platform }}.txt

      - name: Upload launcher artifacts
        uses: actions/upload-artifact@v4
        with:
          name: launcher-${{ matrix.platform }}
          path: dist/**
          if-no-files-found: error

  release:
    if: startsWith(github.ref, 'refs/tags/launcher-v')
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Merge checksum manifests
        shell: bash
        run: |
          find dist -type f -name "SHA256SUMS-*.txt" -print0 | sort -z | xargs -0 cat > dist/SHA256SUMS.txt

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*
